/*
 * crc - Calculate CRCs.
 *
 * Copyright 2014 Toshiaki Yoshida <yoshida@mpc.net>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include <syscon.h>
#include <gpio.h>
#include <usart.h>
#include <mrt.h>
#include <crc.h>

/* USART clock frequency */
#define U_PCLK	(16 * 115200)

#define TESTLEN	32

#define TEST_CRC_CCITT

static const char test_data[1024] = {
	0xf4, 0x16, 0x65, 0xed, 0x96, 0xd0, 0xeb, 0x53,
	0x98, 0xdf, 0xf5, 0xad, 0x5d, 0x9e, 0x89, 0xa3,
	0xc6, 0xd7, 0x4e, 0xf7, 0x51, 0x3e, 0x10, 0x84,
	0x44, 0xd9, 0x73, 0x57, 0x5a, 0xcb, 0x58, 0x4e,
	0xe1, 0xbe, 0x3c, 0x77, 0x8e, 0x27, 0xca, 0x26,
	0x06, 0xbf, 0xd4, 0x64, 0x5d, 0x5d, 0x07, 0x24,
	0x34, 0x55, 0x1b, 0x85, 0x94, 0x2c, 0x0a, 0xd8,
	0x05, 0x7d, 0x2f, 0x60, 0x48, 0x87, 0xae, 0x29,
	0x45, 0xea, 0xa0, 0xd3, 0x12, 0x6a, 0xfa, 0x18,
	0x29, 0xce, 0x7c, 0x86, 0x2b, 0x84, 0xaa, 0x5f,
	0xd9, 0xc6, 0xe4, 0x6d, 0xf2, 0xee, 0x45, 0xf7,
	0x6b, 0x74, 0x57, 0xb3, 0xfc, 0x06, 0xdc, 0x41,
	0xf0, 0x7c, 0x15, 0x02, 0xe6, 0x0f, 0x1b, 0x0f,
	0xdd, 0x97, 0x96, 0x08, 0x1b, 0x40, 0x67, 0xf5,
	0x06, 0x4b, 0x62, 0xf8, 0x3a, 0xa8, 0xf0, 0xa5,
	0x1c, 0x47, 0x59, 0x18, 0x4d, 0x35, 0x5a, 0x3e,
	0xb2, 0x6f, 0x40, 0x98, 0x7e, 0x5b, 0xa8, 0x5b,
	0xf3, 0x3e, 0x63, 0x0e, 0x7e, 0xca, 0x03, 0x85,
	0x15, 0x66, 0x7d, 0x4f, 0x0e, 0x6d, 0xf5, 0x2a,
	0xb5, 0x4e, 0x43, 0x02, 0x83, 0x9d, 0x40, 0x35,
	0x0c, 0x81, 0xce, 0x8a, 0xdc, 0x76, 0xe5, 0xcf,
	0xb4, 0x48, 0xde, 0x32, 0x12, 0xe1, 0xb7, 0x27,
	0x47, 0x35, 0x77, 0x55, 0xa2, 0x6c, 0x80, 0x57,
	0xba, 0xc3, 0x5a, 0x3d, 0x60, 0x9a, 0x73, 0x6c,
	0x1b, 0x41, 0xf6, 0xf8, 0xb7, 0xdb, 0xc7, 0x6b,
	0x23, 0xa5, 0x9d, 0x35, 0x87, 0x55, 0x5c, 0xce,
	0x8a, 0xd3, 0x24, 0x2c, 0x3f, 0xa4, 0x84, 0xf9,
	0x67, 0xde, 0x37, 0xc7, 0x78, 0xaa, 0x33, 0x94,
	0xeb, 0x29, 0x8c, 0xa2, 0x04, 0x53, 0x0d, 0x27,
	0xf9, 0xaa, 0x5c, 0x80, 0xff, 0xb8, 0x4e, 0x89,
	0x8c, 0x72, 0xb6, 0xcb, 0x16, 0x3a, 0xc5, 0x7d,
	0x18, 0xfc, 0x44, 0x90, 0xa6, 0x77, 0x24, 0x91,
	0xa0, 0xb0, 0x33, 0xa4, 0x04, 0x40, 0xcb, 0xfd,
	0xea, 0x27, 0x7d, 0xea, 0xe0, 0xcb, 0x73, 0x6c,
	0x3e, 0x29, 0x37, 0x54, 0x63, 0xfc, 0xd2, 0x7b,
	0xf8, 0x16, 0x0c, 0x9e, 0x8e, 0x30, 0x2f, 0x2e,
	0xe1, 0x62, 0xd3, 0xe5, 0xa2, 0x9e, 0xe2, 0x8d,
	0xc6, 0x5f, 0x77, 0xa6, 0x2a, 0xea, 0x12, 0x68,
	0x14, 0x49, 0xbd, 0x77, 0x46, 0x8f, 0xf3, 0x3e,
	0xa5, 0xff, 0xdd, 0x33, 0x2f, 0x0c, 0x62, 0x10,
	0x6f, 0x35, 0xf5, 0x11, 0xd3, 0xd7, 0x9e, 0x99,
	0x36, 0x15, 0x3f, 0x61, 0x00, 0x51, 0xc9, 0x14,
	0x9b, 0x86, 0x8b, 0xe1, 0x15, 0x7e, 0x1f, 0xbb,
	0x7d, 0xfc, 0xee, 0xad, 0x09, 0x50, 0xbd, 0x78,
	0x85, 0xb3, 0x89, 0x59, 0x8a, 0x28, 0xf2, 0xc1,
	0x3d, 0x32, 0x22, 0x3d, 0x83, 0xeb, 0x51, 0x1e,
	0x72, 0xdd, 0xff, 0x87, 0x5b, 0x1f, 0x42, 0xd9,
	0x1b, 0x31, 0x86, 0x24, 0x81, 0x43, 0x9c, 0x07,
	0xf6, 0x26, 0x60, 0x81, 0x4e, 0x52, 0x42, 0x8b,
	0x84, 0x64, 0xc9, 0x08, 0x4f, 0x1a, 0x26, 0xc1,
	0xf7, 0x26, 0x49, 0x53, 0x45, 0x8b, 0x2c, 0x60,
	0xbc, 0xb2, 0x85, 0x3e, 0xf5, 0x21, 0x45, 0xec,
	0x47, 0xa5, 0x6d, 0x95, 0xf7, 0xaf, 0x21, 0x7c,
	0x13, 0xea, 0x84, 0x62, 0x04, 0xaa, 0x24, 0xfc,
	0xd0, 0x6d, 0x4f, 0x15, 0xf8, 0x7b, 0x76, 0xb5,
	0x2d, 0xfb, 0xf3, 0x22, 0x1c, 0x38, 0x0e, 0x64,
	0xdd, 0x7b, 0xf9, 0xd4, 0x2a, 0x1a, 0x50, 0x3d,
	0x04, 0xd4, 0xa0, 0x09, 0x7f, 0xc4, 0x05, 0x4f,
	0x31, 0x54, 0x65, 0x29, 0xcf, 0xdb, 0xde, 0xfc,
	0xd6, 0xd1, 0x1e, 0xf2, 0x09, 0x2d, 0x56, 0xe6,
	0xa8, 0x50, 0xbb, 0xd3, 0x6a, 0x0b, 0x10, 0x6f,
	0xe0, 0xb0, 0x78, 0x5f, 0x74, 0x7d, 0xae, 0xa5,
	0xd1, 0x13, 0xcf, 0xa0, 0xee, 0xad, 0x9c, 0xc4,
	0x7f, 0xba, 0xb7, 0x88, 0xe7, 0x0d, 0x6f, 0x90,
	0x5d, 0x2a, 0x63, 0xc8, 0x35, 0x73, 0x37, 0x15,
	0x24, 0xaf, 0x74, 0x98, 0x2c, 0x23, 0x3e, 0xfd,
	0x36, 0x0d, 0x9d, 0x25, 0xba, 0x39, 0xe9, 0x39,
	0xf3, 0xa0, 0xc2, 0xdb, 0xae, 0x31, 0x6b, 0x0b,
	0x5b, 0xce, 0xd3, 0x90, 0x41, 0x0a, 0xa6, 0x65,
	0xb9, 0x1a, 0xfe, 0xe5, 0x3d, 0x3c, 0xe2, 0x74,
	0x49, 0x7f, 0x99, 0x03, 0xb8, 0x82, 0x3d, 0xac,
	0x23, 0xff, 0x87, 0xd1, 0x30, 0xf2, 0xdc, 0x8b,
	0xc0, 0xb0, 0x1b, 0x01, 0xba, 0xc1, 0x67, 0x74,
	0xdc, 0x65, 0x59, 0x19, 0xa1, 0x3c, 0x8d, 0xea,
	0xbb, 0x26, 0xed, 0x74, 0xa9, 0x2a, 0x20, 0xcc,
	0x29, 0xa7, 0x9d, 0x59, 0x99, 0x79, 0xe4, 0x59,
	0x29, 0x00, 0x5a, 0xe4, 0xc1, 0xc1, 0x58, 0x9d,
	0x26, 0xb1, 0xb7, 0xc7, 0xed, 0x44, 0xb1, 0xa9,
	0x6b, 0x9f, 0x1d, 0x14, 0xc9, 0x3d, 0xe0, 0xf3,
	0xe4, 0x7d, 0x4c, 0x7d, 0xf6, 0x31, 0xd6, 0x20,
	0x31, 0x30, 0x04, 0xf2, 0xf2, 0x5c, 0x90, 0x18,
	0x0d, 0x47, 0xe0, 0xfb, 0x8b, 0x91, 0xa4, 0xf6,
	0x30, 0xc1, 0x0a, 0xfa, 0xfe, 0xea, 0xed, 0xe2,
	0x67, 0x39, 0x5f, 0x5e, 0x6a, 0x35, 0x7e, 0x9b,
	0x65, 0x82, 0x8e, 0x57, 0xde, 0x1e, 0x70, 0xeb,
	0x65, 0x50, 0xe6, 0xf0, 0xe1, 0x8a, 0xe7, 0x12,
	0x4b, 0xf1, 0x0c, 0x49, 0xdc, 0xf9, 0x2b, 0x43,
	0x32, 0x8a, 0xa1, 0x9d, 0xbf, 0x1f, 0x38, 0x25,
	0xa1, 0xc6, 0x7c, 0x7f, 0xe4, 0xec, 0x6b, 0x49,
	0x3c, 0x51, 0x3a, 0x1e, 0xdc, 0x21, 0x30, 0x27,
	0x12, 0x3c, 0x71, 0xee, 0x35, 0x9c, 0x32, 0x67,
	0x27, 0xd3, 0x04, 0xe6, 0xf3, 0x3d, 0x0b, 0x94,
	0x03, 0x88, 0x14, 0xe8, 0x74, 0x7f, 0x31, 0xb1,
	0xd0, 0x6b, 0xcf, 0xac, 0x8c, 0xff, 0xd4, 0x9f,
	0x3b, 0x45, 0x8d, 0x70, 0xe1, 0xbf, 0xd7, 0x08,
	0x93, 0xdc, 0xef, 0x86, 0x19, 0xfa, 0x1a, 0x1c,
	0x82, 0x2e, 0x04, 0xf7, 0xad, 0x36, 0xa8, 0x7e,
	0xa1, 0x77, 0x2a, 0x2e, 0x76, 0xfe, 0xcd, 0xb1,
	0x43, 0x5a, 0x21, 0x25, 0x1a, 0xf8, 0x2d, 0xad,
	0xd4, 0x1c, 0x33, 0xed, 0x17, 0x4d, 0x0a, 0x99,
	0x7c, 0x0e, 0x90, 0x29, 0x44, 0x38, 0xa7, 0xe6,
	0xaf, 0xd2, 0x14, 0x25, 0xd0, 0xe1, 0xd6, 0x14,
	0x3b, 0xf7, 0x39, 0x55, 0xf0, 0x66, 0x02, 0xc4,
	0x83, 0x35, 0xb2, 0x9a, 0x83, 0xbc, 0x33, 0xff,
	0xca, 0xc4, 0x28, 0x0f, 0xfc, 0xd0, 0xf5, 0xac,
	0xa2, 0x09, 0xd1, 0x72, 0xea, 0xa8, 0x86, 0x25,
	0x9f, 0xbf, 0x7b, 0x8f, 0x26, 0x7d, 0x54, 0xa9,
	0xb3, 0x06, 0x43, 0x36, 0xc2, 0x76, 0x35, 0x8c,
	0x3a, 0x5d, 0x9b, 0x37, 0x2d, 0x90, 0xe3, 0xcf,
	0x99, 0xb4, 0x42, 0x83, 0x5c, 0xc8, 0xa9, 0xfc,
	0x88, 0x24, 0x8b, 0xae, 0xa1, 0xdf, 0x57, 0x54,
	0xe5, 0x9a, 0x8a, 0xa7, 0x10, 0xbf, 0x34, 0x4b,
	0x1d, 0xcf, 0x82, 0x4a, 0x60, 0x65, 0x1a, 0xf9,
	0x19, 0x5c, 0x7d, 0x76, 0x24, 0x26, 0x72, 0xac,
	0x4a, 0xfd, 0x5a, 0xeb, 0xdd, 0xb1, 0x40, 0xc2,
	0x4b, 0xca, 0x6a, 0x5c, 0x8a, 0x9e, 0xa7, 0xa7,
	0x6d, 0x29, 0xf1, 0xcd, 0x8e, 0x0b, 0xc7, 0xa7,
	0x67, 0x44, 0x1d, 0x8c, 0x6a, 0x8f, 0x38, 0xb4,
	0x8d, 0x93, 0x9f, 0x6a, 0x44, 0xdf, 0x2c, 0x90,
	0xaa, 0x96, 0xec, 0x34, 0x34, 0x93, 0xdb, 0xa2,
	0xbc, 0xcc, 0x6f, 0x4a, 0xd8, 0x36, 0xf1, 0x3f,
	0x7a, 0x0f, 0xcb, 0xe4, 0x9e, 0x04, 0x98, 0x2b,
	0x97, 0x38, 0x95, 0xdb, 0x17, 0xc2, 0x6b, 0xc1,
	0x58, 0x57, 0xf5, 0x8d, 0xea, 0xd0, 0x2f, 0xa6,
	0x9d, 0x9e, 0xf0, 0x75, 0xd5, 0xe2, 0xb4, 0x4f,
	0xf1, 0x80, 0x34, 0x8f, 0x84, 0xcc, 0xbb, 0x1b,
	0x04, 0x50, 0xf6, 0x1c, 0x12, 0x62, 0xdd, 0x6b,
	0xb9, 0xd3, 0xf8, 0xa4, 0xa3, 0x27, 0x4a, 0x40,
};

struct test_result {
	int init;
	int offset;
	int length;
	int result;
};

#ifdef TEST_CRC_CCITT
static const struct test_result crc_ccitt_result[TESTLEN] = {
	{0x000099c5, 59,  181, 0x00002291},
	{0x0000f89a, 29,  106, 0x00003242},
	{0x0000faea, 14,  490, 0x0000c09f},
	{0x0000731e, 29,  110, 0x0000f896},
	{0x000011ea, 24,  137, 0x00009e0a},
	{0x000082ef, 41,  127, 0x0000a5ac},
	{0x0000b20b, 59,  225, 0x000045d7},
	{0x00005be8, 38,  411, 0x00006073},
	{0x0000dfbb, 30,   63, 0x0000d1fa},
	{0x00009e5f,  5,  393, 0x0000d75f},
	{0x0000a99f, 11,  452, 0x0000154e},
	{0x00006455, 37,  481, 0x0000915c},
	{0x000092bf, 15,  495, 0x00001fbb},
	{0x00006aa9, 45,  397, 0x0000dc73},
	{0x00005b17, 24,  485, 0x00000718},
	{0x0000e1a0,  7,  398, 0x00000875},
	{0x0000c01f, 18,  330, 0x00006441},
	{0x00007f01, 58,  368, 0x00009dd5},
	{0x0000a09c, 54,  143, 0x0000e0d5},
	{0x00005edb, 21,  212, 0x00005ae7},
	{0x00006c64, 52,  223, 0x00000f96},
	{0x00004e29,  9,  389, 0x0000fd07},
	{0x0000c40a,  8,  276, 0x00008c1d},
	{0x00009dfa, 49,  450, 0x00000e2e},
	{0x00001987,  8,   90, 0x0000c5bd},
	{0x0000216c, 40,  481, 0x0000bb54},
	{0x000076fb,  8,  371, 0x000085f8},
	{0x0000f445,  9,  237, 0x00009a5f},
	{0x000093b5, 37,   35, 0x0000e2e5},
	{0x00009644,  0,  440, 0x0000f080},
	{0x00002b19, 36,  237, 0x0000077a},
	{0x0000ebf8, 13,  118, 0x0000cd72},
};
#endif
#ifdef TEST_CRC16
static const struct test_result crc16_result[TESTLEN] = {
	{0x0000d17d, 24,  191, 0x0000ff2e},
	{0x0000d692, 18,  432, 0x0000ff75},
	{0x00006e54, 25,  441, 0x00002b24},
	{0x0000aaae,  5,  353, 0x0000a4a8},
	{0x00000e8f,  0,  297, 0x00004903},
	{0x00004c02,  5,  498, 0x00005479},
	{0x0000beef, 59,  343, 0x00007cb1},
	{0x00004713, 63,  407, 0x0000f531},
	{0x000082cb, 24,   60, 0x0000ec4f},
	{0x00001bb8, 17,  265, 0x00005855},
	{0x0000762f, 14,  481, 0x0000bed7},
	{0x000024ee, 32,  179, 0x0000b08d},
	{0x0000929e, 52,  268, 0x0000c075},
	{0x00001a57, 34,  210, 0x00004eb3},
	{0x00009db9, 49,  402, 0x0000f763},
	{0x0000dce2, 51,  152, 0x00006f90},
	{0x000056d5, 35,  339, 0x0000b7ba},
	{0x0000ac2c, 54,   82, 0x00004e59},
	{0x00003bc4,  1,  107, 0x0000d1ca},
	{0x00007200, 58,  124, 0x0000d0e0},
	{0x00009d09, 41,   10, 0x00006dbb},
	{0x000080eb, 23,   43, 0x0000bea2},
	{0x0000bb9e, 53,  159, 0x00009cd4},
	{0x000066ab, 13,  450, 0x00003b80},
	{0x0000a37d,  6,  371, 0x0000e025},
	{0x0000e90f, 40,  295, 0x00005ab1},
	{0x00002ba7, 61,  458, 0x00005871},
	{0x0000fefa, 42,  384, 0x00008c5f},
	{0x0000f94d, 46,    1, 0x0000f778},
	{0x000045b8, 46,   59, 0x0000a8fc},
	{0x0000d034, 55,  164, 0x00000b44},
	{0x00006a3e, 34,  507, 0x000013c5},
};
#endif
#ifdef TEST_CRC32_LE
static const struct test_result crc32_le_result[TESTLEN] = {
	{0xea694b41, 49,  265, 0x0af00349},
	{0xb1ec143e, 11,  361, 0x71ef80f6},
	{0xf844743e, 56,  300, 0x50a9261d},
	{0xaf656a20, 42,  303, 0x7e660841},
	{0x691a94d4, 47,  103, 0x895a9e4f},
	{0x94824cb1, 31,   48, 0x1925085c},
	{0xe0ec7853, 39,  401, 0x95df4509},
	{0xe292a48a, 12,  251, 0xbe37f445},
	{0xefcb597d,  4,  439, 0x208e5265},
	{0x6dbb1ecf, 32,  511, 0x03b6c2e8},
	{0x930e3598, 44,  115, 0xc0d3ebeb},
	{0x9fb8f016, 35,  211, 0x884b0685},
	{0x84eafc52, 58,  364, 0x9c091e62},
	{0x4903135a, 28,  496, 0x839cd01c},
	{0x8bad3483,  1,   63, 0xdc7da458},
	{0xd90d9f0d, 59,  216, 0x67185706},
	{0xf88bc73f, 15,   70, 0x5a18e713},
	{0xe60f61af,  6,  285, 0xf4d8f0e0},
	{0x9748eb72, 16,  256, 0xa31e4bc6},
	{0xdb880133, 19,  114, 0xd4c8cdce},
	{0xfd86ab0e, 30,  137, 0x720392f0},
	{0xbe68997a, 57,   21, 0x5251f7a1},
	{0xcdfd83fa, 21,  267, 0xb806f756},
	{0x2308f390, 35,  403, 0xf91de59b},
	{0xbacfda73, 25,  222, 0x3be89442},
	{0x3c224e1f, 59,  362, 0xf7270736},
	{0x3991d58c, 43,  281, 0x72c65ebc},
	{0xd6bf4a3e, 11,   69, 0x1516663e},
	{0xf54cef69, 15,  436, 0x9110b096},
	{0x88e38b48, 10,  225, 0xf4556d00},
	{0x0f43b61f, 44,   75, 0xc765e801},
	{0xa9af6dcf, 30,  126, 0x3f9c7d83},
};
#endif
#ifdef TEST_CRC32_BE
static const struct test_result crc32_be_result[TESTLEN] = {
	{0x4842cfb7, 29,  101, 0xf471024a},
	{0x1dd71f58, 15,  360, 0x8f155722},
	{0xf4e4623a,  2,  420, 0x22f1dcbf},
	{0xac79e20d, 41,  453, 0x6272f39b},
	{0xd177bab8, 58,   90, 0x315923bc},
	{0x46015344, 59,  324, 0x6281bfc0},
	{0x0963af27, 15,  274, 0xf2148dc9},
	{0x1cf7d56d, 16,  313, 0x126a86b4},
	{0xa5241ced, 30,  251, 0xe8ed7e78},
	{0x3c46416e, 36,  298, 0xc67b1c17},
	{0xa3a886e6, 14,   33, 0x2710e13a},
	{0x68f39cb8, 39,  106, 0x4e3b6469},
	{0x57704761,  5,  369, 0x02c9cb16},
	{0x9aa54600, 53,    8, 0x07ea84d3},
	{0xf5287a44, 26,   31, 0x14917935},
	{0x4fb16eaa, 24,  214, 0x0e8e368d},
	{0x8b9860f7, 17,  478, 0x06918cff},
	{0xa265d235,  8,   13, 0xfbf676e2},
	{0x591bf5d7, 47,   15, 0x784b9ead},
	{0x928f8816, 57,  511, 0x29d4b516},
	{0xcf77913e, 49,   28, 0x9e052ae7},
	{0xd73f7a26, 36,  103, 0x2df60c29},
	{0xf46b653e,  6,   28, 0x6bf3cee1},
	{0xd3e855de, 50,  384, 0x8482c985},
	{0xb6d5f0c4, 30,  314, 0xbf85e9c2},
	{0xc2f92067,  8,   21, 0x6f0e2e92},
	{0x163e3577, 36,  205, 0x6f5de6a6},
	{0xbd8dda9d, 12,  260, 0x6085fc7e},
	{0x6bdc1a3d, 32,  283, 0xa7e856d0},
	{0x94640544,  2,  207, 0xa4b22081},
	{0x6a82ee08, 43,  106, 0x423d0422},
	{0x43e605de, 43,  188, 0x0861dda6},
};
#endif

/* Set LPC810 to 24 MHz. */
static void clock_setup(void)
{
	/* Set up PLL (Fclkin = 12MHz (IRC), Fclkout (Main clock) = 24MHz) */
	syscon_enable_pll(SYSCON_IRC, 2, 4);

	/* Select PLL as system clock source. */
	syscon_set_system_clock(SYSCON_PLL_OUT, 1);

	/* Enable USART clock (U_PCLK). */
	syscon_set_usart_clock(24000000, U_PCLK);
}

static void gpio_setup(void)
{
	/* Enable GPIO clock. */
	// syscon_enable_clock(SYSCON_GPIO);

	/* Enable switch matrix clock. */
	// syscon_enable_clock(SYSCON_SWM);

	/* Enable IOCON clock. */
	syscon_enable_clock(SYSCON_IOCON);

	/* Prevent the pins from internally floating. */
	gpio_config(GPIO_OUTPUT, GPIO_IO, PIO0_10 | PIO0_11);
	gpio_clear(PIO0_10 | PIO0_11);

	/* Set PIO0_2 and PIO0_3 to 'output push-pull' (LED). */
	gpio_config(GPIO_OUTPUT, 0, PIO0_2 | PIO0_3);

	/* Set PIO0_4 to 'USART0 TXD'. */
	gpio_config(GPIO_U0_TXD, GPIO_HYST, PIO0_4);
}

static void usart_setup(void)
{
	/* Enable USART0 clock. */
	syscon_enable_clock(SYSCON_UART0);

	/* Set up USART0. */
	usart_init(USART0, U_PCLK, 115200, 8, 1, USART_PARITY_NONE,
		   USART_FLOW_NONE);
}

static void mrt_setup(void)
{
	/* Enable MRT clock. */
	syscon_enable_clock(SYSCON_MRT);

	/* Set channel 0 to 'one-shot interrupt mode'. */
	mrt_set_mode(MRT0, MRT_ONE_SHOT);
}

static void crc_setup(void)
{
	/* Enable CRC clock. */
	syscon_enable_clock(SYSCON_CRC);
}

static void print_hex(int c)
{
	int d;

	d = (c >> 4) & 0xf;
	if (d > 9)
		d += 'a' - 10;
	else
		d += '0';
	usart_send_blocking(USART0, d);
	d = c & 0xf;
	if (d > 9)
		d += 'a' - 10;
	else
		d += '0';
	usart_send_blocking(USART0, d);
}

static void print_hex_half_word(int w)
{
	print_hex((w >> 8) & 0xff);
	print_hex(w & 0xff);
}

static void print_hex_word(int w)
{
	print_hex((w >> 24) & 0xff);
	print_hex((w >> 16) & 0xff);
	print_hex((w >> 8) & 0xff);
	print_hex(w & 0xff);
}

static void print_int(int d)
{
	bool zerosup;
	int i;

	if (d < 0) {
		usart_send_blocking(USART0, '-');
		d = -d;
	}
	zerosup = true;
	for (i = 1000000000; i > 0; i /= 10) {
		if (d / i || i == 1 || !zerosup) {
			usart_send_blocking(USART0, d / i + '0');
			d %= i;
			zerosup = false;
		}
	}
}

static void xprintf(char *p, int arg0, int arg1, int arg2)
{
	int arg[3];
	int i;

	arg[0] = arg0;
	arg[1] = arg1;
	arg[2] = arg2;
	i = 0;
	while (*p != '\0') {
		if (*p == '%') {
			switch (*++p) {
			case '%':
				usart_send_blocking(USART0, *p++);
				break;
			case 'x':
				if (i < 3)
					print_hex(arg[i++]);
				p++;
				break;
			case 'h':
				if (i < 3)
					print_hex_half_word(arg[i++]);
				p++;
				break;
			case 'w':
				if (i < 3)
					print_hex_word(arg[i++]);
				p++;
				break;
			case 'd':
				if (i < 3)
					print_int(arg[i++]);
				p++;
				break;
			default:
				usart_send_blocking(USART0, '?');
				p++;
				break;
			}
		} else {
			usart_send_blocking(USART0, *p++);
		}
	}
}

static void xputs(char *p)
{
	while (*p != '\0')
		usart_send_blocking(USART0, *p++);
	usart_send_blocking(USART0, '\r');
	usart_send_blocking(USART0, '\n');
}

static void delay_ms(int ms)
{
	mrt_set_interval(MRT0, 24000000 / 1000 * ms);

	while (!mrt_get_channel_status(MRT0, MRT_INT))
		;

	mrt_clear_channel_status(MRT0, MRT_INT);
}

#if defined(TEST_CRC_CCITT) || defined(TEST_CRC16)
static int bitreverse16(int data)
{
	int i;
	int r;

	r = 0;
	for (i = 0; i < 16; i++) {
		if (data & (1 << i))
			r |= 1 << (15 - i);
	}
	return r;
}
#endif

#if defined(TEST_CRC32_LE)
static int bitreverse32(int data)
{
	int i;
	int r;

	r = 0;
	for (i = 0; i < 32; i++) {
		if (data & (1 << i))
			r |= 1 << (31 - i);
	}
	return r;
}
#endif

int main(void)
{
	int i;
	int r;
	bool error_flag;

	clock_setup();
	gpio_setup();
	usart_setup();
	mrt_setup();
	crc_setup();

	xputs("CRC");

	while (1) {
		/* LED1 on/off */
		gpio_toggle(PIO0_2);

#ifdef TEST_CRC_CCITT
		xputs("CRC-CCITT");
		crc_set_mode(CRC_CCITT | CRC_BIT_RVS_WR | CRC_BIT_RVS_SUM);

		error_flag = false;
		for (i = 0; i < TESTLEN; i++) {
			r = crc_calc(bitreverse16(crc_ccitt_result[i].init),
				     (char *)test_data +
				     crc_ccitt_result[i].offset,
				     crc_ccitt_result[i].length);
			if (r != crc_ccitt_result[i].result) {
				xprintf("CRC-CCITT failed: 0x%w (0x%w)\r\n", r,
					crc_ccitt_result[i].result, 0);
				error_flag = true;

				/* LED2 on */
				gpio_set(PIO0_3);
			}
		}
		if (!error_flag)
			xputs("Passed");
#endif
#ifdef TEST_CRC16
		xputs("CRC-16");
		crc_set_mode(CRC_16 | CRC_BIT_RVS_WR | CRC_BIT_RVS_SUM);

		error_flag = false;
		for (i = 0; i < TESTLEN; i++) {
			r = crc_calc(bitreverse16(crc16_result[i].init),
				     (char *)test_data +
				     crc16_result[i].offset,
				     crc16_result[i].length);
			if (r != crc16_result[i].result) {
				xprintf("CRC-16 failed: 0x%w (0x%w)\r\n", r,
					crc16_result[i].result, 0);
				error_flag = true;

				/* LED2 on */
				gpio_set(PIO0_3);
			}
		}
		if (!error_flag)
			xputs("Passed");
#endif
#ifdef TEST_CRC32_LE
		xputs("CRC-32(LE)");
		crc_set_mode(CRC_32 | CRC_BIT_RVS_WR | CRC_BIT_RVS_SUM);

		error_flag = false;
		for (i = 0; i < TESTLEN; i++) {
			r = crc_calc(bitreverse32(crc32_le_result[i].init),
				     (char *)test_data +
				     crc32_le_result[i].offset,
				     crc32_le_result[i].length);
			if (r != crc32_le_result[i].result) {
				xprintf("CRC-32(LE) failed: 0x%w (0x%w)\r\n",
					r, crc32_le_result[i].result, 0);
				error_flag = true;

				/* LED2 on */
				gpio_set(PIO0_3);
			}
		}
		if (!error_flag)
			xputs("Passed");
#endif
#ifdef TEST_CRC32_BE
		xputs("CRC-32(BE)");
		crc_set_mode(CRC_32);

		error_flag = false;
		for (i = 0; i < TESTLEN; i++) {
			r = crc_calc(crc32_be_result[i].init,
				     (char *)test_data +
				     crc32_be_result[i].offset,
				     crc32_be_result[i].length);
			if (r != crc32_be_result[i].result) {
				xprintf("CRC-32(BE) failed: 0x%w (0x%w)\r\n",
					r, crc32_be_result[i].result, 0);
				error_flag = true;

				/* LED2 on */
				gpio_set(PIO0_3);
			}
		}
		if (!error_flag)
			xputs("Passed");
#endif
		delay_ms(1000);
	}

	return 0;
}
